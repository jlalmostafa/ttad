<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="theme-color" content="#6a11cb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%236a11cb'/%3E%3Ctext x='50' y='70' font-size='70' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ“¦%3C/text%3E%3C/svg%3E">
    <!-- Manifest Ù…Ø¶Ù…Ù† Ù…Ø¨Ø§Ø´Ø±Ø© -->
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª&quot;,
        &quot;short_name&quot;: &quot;Ø·Ù„Ø¨Ø§Øª&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#f5f7fa&quot;,
        &quot;theme_color&quot;: &quot;#6a11cb&quot;,
        &quot;icons&quot;: [{
            &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%236a11cb'/%3E%3Ctext x='50' y='70' font-size='70' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ“¦%3C/text%3E%3C/svg%3E&quot;,
            &quot;sizes&quot;: &quot;192x192&quot;,
            &quot;type&quot;: &quot;image/svg+xml&quot;
        }]
    }">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØ±ÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Reset and base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        html {
            font-size: 16px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            padding: 0;
            margin: 0;
            line-height: 1.5;
            color: #1c1e21;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
        @media (max-width: 600px) { html { font-size: 14px; } }
        @media (min-width: 1200px) { html { font-size: 18px; } }

        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 1rem 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª - ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
        #installBtn {
            background: white;
            color: #6a11cb;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: 1px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #installBtn:hover {
            background: #f0f0f0;
            transform: scale(1.02);
        }
        #installBtn i {
            font-size: 1.2rem;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.8rem 1rem;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            border-bottom: 2px solid #6a11cb;
            position: sticky;
            top: 4.5rem;
            z-index: 99;
        }

        .nav-btn {
            background: #f0f2f5;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 2rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #050505;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            box-shadow: 0 2px 6px rgba(106, 17, 203, 0.3);
        }

        .container {
            max-width: 75rem;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 1.2rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 1rem;
            animation: fadeIn 0.2s ease;
        }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(0.3rem); } to { opacity: 1; transform: translateY(0); } }

        .section-title {
            font-size: 1.6rem;
            margin-bottom: 1.5rem;
            color: #1c1e21;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            border-bottom: 2px solid #e4e6eb;
            padding-bottom: 0.8rem;
        }
        .section-title i { color: #6a11cb; font-size: 1.8rem; }

        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #050505;
            font-weight: 600;
            font-size: 1rem;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid #ccd0d5;
            border-radius: 0.8rem;
            font-size: 1rem;
            background: #ffffff;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }

        .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-admin {
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 600;
        }
        .btn-primary { background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; }
        .btn-secondary { background: #e4e6eb; color: #050505; }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-danger { background: linear-gradient(135deg, #eb3349, #f45c43); color: white; }
        .btn-admin { background: linear-gradient(135deg, #8e2de2, #4a00e0); color: white; }
        .btn-primary:hover, .btn-secondary:hover, .btn-success:hover, .btn-danger:hover, .btn-admin:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #map {
            height: 25rem;
            width: 100%;
            border-radius: 1.2rem;
            margin-bottom: 1rem;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .location-status {
            background: #f0f2f5;
            padding: 1rem 1.2rem;
            border-radius: 2rem;
            margin: 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #050505;
            border: 1px solid #ccd0d5;
            font-size: 0.95rem;
            flex-wrap: wrap;
        }
        .filter-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.8rem;
            flex-wrap: wrap;
            background: #f0f2f5;
            padding: 1rem;
            border-radius: 2rem;
        }
        .filter-bar select {
            flex: 2;
            min-width: 12rem;
            padding: 0.8rem 1rem;
            border: 1px solid #ccd0d5;
            border-radius: 2rem;
            font-size: 0.95rem;
            background: white;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
            gap: 1.2rem;
            margin-top: 1.2rem;
        }
        .order-item {
            background: white;
            border-radius: 1.2rem;
            padding: 1.2rem;
            border-right: 0.3rem solid #6a11cb;
            transition: all 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #e4e6eb;
        }
        .order-item:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(106,17,203,0.1); }
        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        .order-item-service { font-weight: 700; color: #050505; font-size: 1.1rem; }
        .order-item-status { font-size: 0.8rem; padding: 0.3rem 0.8rem; border-radius: 2rem; font-weight: 600; }
        .status-new { background: #dbeafe; color: #1d4ed8; }
        .status-taken { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #b91c1c; }
        .order-item-details { color: #4b5563; font-size: 0.95rem; margin: 0.8rem 0; line-height: 1.5; }
        .order-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.8rem;
            font-size: 0.9rem;
            color: #6b7280;
        }
        .order-item-actions { display: flex; gap: 0.5rem; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            padding: 1rem;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 1.5rem;
            max-width: 35rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.8rem;
            position: relative;
        }
        .modal-close {
            position: absolute; top: 1rem; left: 1rem;
            background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280;
        }

        .service-checkbox-group {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(9rem, 1fr)); gap: 0.8rem;
            margin-top: 1rem; background: #f9fafb; padding: 1rem; border-radius: 1rem;
        }
        .service-checkbox {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
            background: white; border-radius: 0.8rem; border: 1px solid #e5e7eb; font-size: 0.9rem;
        }

        .channels-table {
            width: 100%; border-collapse: collapse; margin: 1.5rem 0; border-radius: 1rem;
            overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9rem;
        }
        .channels-table th, .channels-table td { border: 1px solid #e5e7eb; padding: 0.8rem; text-align: right; }
        .channels-table th { background: #f3f4f6; font-weight: 700; }

        .channel-link { background: #25D366; color: white; padding: 0.4rem 1rem; border-radius: 2rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.85rem; }
        .admin-panel { background: #f3f4f6; padding: 1.5rem; border-radius: 1.2rem; margin-bottom: 1.8rem; border: 1px solid #d1d5db; }

        .footer {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
            font-size: 0.9rem;
            background: white;
            margin-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            z-index:10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .loading-box {
            background: white;
            padding: 2rem;
            border-radius: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }
        .loading-box i { font-size: 3rem; color: #6a11cb; margin-bottom: 1rem; }
        .loading-box p { font-size: 1.2rem; color: #1f2937; font-weight: 600; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-tasks"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <button id="installBtn"><i class="fas fa-download"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    </div>
    
    <div class="nav">
        <button class="nav-btn active" id="homeBtn"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-btn" id="customerBtn"><i class="fas fa-user"></i> Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
        <button class="nav-btn" id="providerBtn"><i class="fas fa-truck"></i> Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</button>
        <button class="nav-btn btn-admin" id="adminBtn"><i class="fas fa-crown"></i> Ø§Ù„Ø£Ø¯Ù…Ù†</button>
    </div>
    
    <div class="container">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="homeSection" class="content-section active">
            <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</h2>
            <div id="map"></div>
            
            <div class="location-status" id="locationStatus">
                <i class="fas fa-map-pin"></i>
                <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
                <button id="locateMeBtn" class="btn-secondary" style="margin-right: auto; padding: 0.5rem 1.2rem;">
                    <i class="fas fa-crosshairs"></i> ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
            
            <div class="filter-bar">
                <select id="serviceFilter">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
                    <option value="taxi">ØªÙƒØ³ÙŠ</option>
                    <option value="delivery">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª</option>
                    <option value="food">ØªÙˆØµÙŠÙ„ ÙˆØ¬Ø¨Ø§Øª</option>
                    <option value="vegetables">ØªÙˆØµÙŠÙ„ Ø®Ø¶Ø±ÙˆØ§Øª</option>
                    <option value="rental">Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ù†Ù‚Ù„</option>
                    <option value="goods">Ù†Ù‚Ù„ Ø¨Ø¶Ø§Ø¦Ø¹</option>
                    <option value="repair">ØªØµÙ„ÙŠØ­ / ØµÙŠØ§Ù†Ø©</option>
                    <option value="electrician">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</option>
                    <option value="appliance">Ø¥ØµÙ„Ø§Ø­ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                    <option value="store">Ù…Ø­Ù„ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                    <option value="restaurant">Ù…Ø·Ø§Ø¹Ù…</option>
                </select>
                <button class="btn-primary" id="newOrderBtn"><i class="fas fa-plus"></i> Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            
            <h3 style="margin: 1.8rem 0 1rem; font-size: 1.3rem;"><i class="fas fa-location-arrow"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (Ø¶Ù…Ù† 2 ÙƒÙ…)</h3>
            <div id="nearbyOrders" class="orders-grid"></div>
            
            <h3 style="margin: 1.8rem 0 1rem; font-size: 1.3rem;"><i class="fas fa-lightbulb"></i> Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ø®Ø¯Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù‚Ø±ÙŠØ¨Ø©</h3>
            <div id="suggestedOrders" class="orders-grid"></div>
        </div>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† -->
        <div id="customerSection" class="content-section">
            <h2 class="section-title"><i class="fas fa-user-circle"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</h2>
            <form id="customerForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… <span style="color: red;">*</span></label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ <span style="color: red;">*</span></label>
                    <input type="tel" id="customerPhone" required placeholder="+963*********" 
                           pattern="\+963[0-9]{9,}" title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ +963 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 13 Ø±Ù‚Ù… (Ù…Ø«Ø§Ù„: +963912345678)">
                </div>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
            </form>
            
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div id="myOrdersList" class="orders-grid"></div>
        </div>
        
        <!-- Ù‚Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø© -->
        <div id="providerSection" class="content-section">
            <h2 class="section-title"><i class="fas fa-id-card"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</h2>
            <form id="providerForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… <span style="color: red;">*</span></label>
                    <input type="text" id="providerName" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ø¯Ù…Ù‡Ø§ <span style="color: red;">*</span></label>
                    <div class="service-checkbox-group">
                        <label class="service-checkbox"><input type="checkbox" name="services" value="taxi"> ØªÙƒØ³ÙŠ</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="delivery"> ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="food"> ØªÙˆØµÙŠÙ„ ÙˆØ¬Ø¨Ø§Øª</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="vegetables"> ØªÙˆØµÙŠÙ„ Ø®Ø¶Ø±ÙˆØ§Øª</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="rental"> Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ù†Ù‚Ù„</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="goods"> Ù†Ù‚Ù„ Ø¨Ø¶Ø§Ø¦Ø¹</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="repair"> ØªØµÙ„ÙŠØ­ / ØµÙŠØ§Ù†Ø©</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="electrician"> ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="appliance"> Ø¥ØµÙ„Ø§Ø­ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="store"> Ù…Ø­Ù„ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</label>
                        <label class="service-checkbox"><input type="checkbox" name="services" value="restaurant"> Ù…Ø·Ø§Ø¹Ù…</label>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </form>
            
            <div id="providerChannelsContainer" style="margin-top: 2rem; display: none;">
                <h3 style="font-size: 1.3rem;"><i class="fas fa-link"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ø¯Ù…Ù‡Ø§</h3>
                <p style="font-size: 0.95rem;">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</p>
                <table class="channels-table" id="providerChannelsTable">
                    <thead><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©</th><th>Ø§Ù†Ø¶Ù…Ø§Ù…</th></tr></thead>
                    <tbody id="providerChannelsBody"></tbody>
                </table>
            </div>
            
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø©</h3>
            <div id="takenOrdersList"></div>
        </div>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† -->
        <div id="adminSection" class="content-section">
            <h2 class="section-title"><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
            
            <div id="adminLogin" class="admin-panel">
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                    <input type="password" id="adminPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                </div>
                <button id="adminLoginBtn" class="btn-admin"><i class="fas fa-lock-open"></i> Ø¯Ø®ÙˆÙ„</button>
            </div>
            
            <div id="adminContent" style="display: none;">
                <h3 style="font-size: 1.3rem;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
                
                <div class="form-group">
                    <label>ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¹Ø§Ù…</label>
                    <input type="text" id="adminBotToken" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                </div>
                
                <p style="font-size: 0.95rem;">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ù„ÙƒÙ„ Ø®Ø¯Ù…Ø© (Ù…Ø«Ù„ @username Ø£Ùˆ -100...). ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨ÙˆØª Ù…Ø¶Ø§ÙØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© ÙƒÙ…Ø´Ø±Ù.</p>
                
                <table class="channels-table" id="adminChannelsTable">
                    <thead><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©</th><th>Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th></tr></thead>
                    <tbody id="adminChannelsBody"></tbody>
                </table>
                
                <button id="saveChannelsBtn" class="btn-success"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 style="font-size: 1.6rem;"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="newOrderForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                    <select id="orderService" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©</option>
                        <option value="taxi">ØªÙƒØ³ÙŠ</option>
                        <option value="delivery">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª</option>
                        <option value="food">ØªÙˆØµÙŠÙ„ ÙˆØ¬Ø¨Ø§Øª</option>
                        <option value="vegetables">ØªÙˆØµÙŠÙ„ Ø®Ø¶Ø±ÙˆØ§Øª</option>
                        <option value="rental">Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ù†Ù‚Ù„</option>
                        <option value="goods">Ù†Ù‚Ù„ Ø¨Ø¶Ø§Ø¦Ø¹</option>
                        <option value="repair">ØªØµÙ„ÙŠØ­ / ØµÙŠØ§Ù†Ø©</option>
                        <option value="electrician">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</option>
                        <option value="appliance">Ø¥ØµÙ„Ø§Ø­ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                        <option value="store">Ù…Ø­Ù„ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                        <option value="restaurant">Ù…Ø·Ø§Ø¹Ù…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                    <textarea id="orderDetails" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <div id="orderLocationInfo">
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p>
                        <button type="button" id="pickLocationBtn" class="btn-secondary">
                            <i class="fas fa-map-pin"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="submit" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                    <button type="button" class="btn-secondary" onclick="app.closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div id="locationPickerModal" class="modal">
        <div class="modal-content" style="max-width: 50rem;">
            <button class="modal-close">&times;</button>
            <h2 style="font-size: 1.6rem;"><i class="fas fa-map-marker-alt"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
            <div id="locationMap" style="height: 20rem; margin: 1rem 0; border-radius: 1rem; border: 1px solid #ddd;"></div>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button id="useCurrentLocationBtn" class="btn-secondary">
                    <i class="fas fa-location-arrow"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
                </button>
                <button id="confirmLocationBtn" class="btn-primary">
                    <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 style="font-size: 1.6rem;"><i class="fas fa-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
            <div id="orderDetailsContent" style="font-size: 1rem;"></div>
        </div>
    </div>
    
    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingOverlay">
        <div class="loading-box">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>
    
    <div class="footer">
        <p>ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…: 00963949340870</p>
        <p style="color:red;">Ø´ÙƒØ§ÙˆÙŠ: 00963949340870</p>
        <p>ØªØµÙ…ÙŠÙ…: Ø¬Ù„Ø§Ù„ Ø§Ù„Ù…ØµØ·ÙÙ‰</p>
        <p id="appStatus" style="color: #6b7280;">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²</p>
        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2025</p>
    </div>
    
    <script>
        // ================== Service Worker Registration ==================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }

        // ================== Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ==================
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø¯Ø« beforeinstallprompt (ÙŠÙØ·Ù„Ù‚ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ«Ø¨ÙŠØª)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // Ù†Ù…Ù†Ø¹ Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†Ø§ÙØ°Ø©
            deferredPrompt = e; // Ù†Ø®Ø²Ù† Ø§Ù„Ø­Ø¯Ø« Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
            console.log('beforeinstallprompt fired');
            // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡
        });

        // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¯Ø« Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª
                    installBtn.style.display = 'none';
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null; // Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† deferredPrompt Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹
                // Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙŠØ¯ÙˆÙŠ
                Swal.fire({
                    title: 'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
                    html: '<p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙƒØ§Ù„ØªØ§Ù„ÙŠ:</p>' +
                          '<ul style="text-align:right; list-style:inside;">' +
                          '<li>Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) Ø«Ù… Ø§Ø®ØªØ± "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" Ø£Ùˆ "Install App".</li>' +
                          '<li>Ø¹Ù„Ù‰ Ø¢ÙŠÙÙˆÙ†: Ø§ÙØªØ­ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙØ­Ø© (Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³Ù‡Ù…) Ø«Ù… Ø§Ø®ØªØ± "Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" (Add to Home Screen).</li>' +
                          '</ul>',
                    icon: 'info',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        });

        // Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ«Ø¨ÙŠØª (Ù‚Ø¯ Ù„Ø§ ÙŠÙØ·Ù„Ù‚ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª)
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installBtn.style.display = 'none';
        });

        // ================== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==================
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwgPe-dUI3wh599QmvcQZGcXllE9z6g1qMnTZ6QirjUZ6Wkxk9TdounFFqiwRZjZPY3dw/exec';
        const ADMIN_PASSWORD = '009911';
        
        class TalabatApp {
            constructor() {
                this.config = {
                    API_BASE_URL,
                    MAP_CENTER: [35.9312, 36.6336],
                    MAP_ZOOM: 12,
                    UPDATE_INTERVAL: 30000,
                    ORDER_TIMEOUT: 10 * 60 * 1000, // 10 Ø¯Ù‚Ø§Ø¦Ù‚
                    TAKEN_TIMEOUT: 60 * 1000,
                    NEARBY_DISTANCE: 2,
                };
                
                this.state = {
                    user: null,
                    provider: null,
                    orders: [],
                    channels: {},
                    botToken: '',
                    map: null,
                    locationPickerMap: null,
                    markers: {},
                    locationMarker: null,
                    currentPosition: null,
                    selectedLocation: null,
                    selectedOrderLocation: null,
                    updateTimer: null,
                    lastFilter: 'all',
                    takenOrders: [],
                    newOrdersCheck: [],
                    isFirstLoad: true,
                    adminLoggedIn: false
                };
                
                this.serviceIcons = {
                    taxi: 'fas fa-taxi', delivery: 'fas fa-truck', food: 'fas fa-utensils',
                    vegetables: 'fas fa-carrot', rental: 'fas fa-truck-moving', goods: 'fas fa-boxes',
                    repair: 'fas fa-wrench', electrician: 'fas fa-bolt', appliance: 'fas fa-tv',
                    store: 'fas fa-store', restaurant: 'fas fa-hotel',
                };
                
                this.serviceNames = {
                    taxi: 'ØªÙƒØ³ÙŠ', delivery: 'ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª', food: 'ØªÙˆØµÙŠÙ„ ÙˆØ¬Ø¨Ø§Øª',
                    vegetables: 'ØªÙˆØµÙŠÙ„ Ø®Ø¶Ø±ÙˆØ§Øª', rental: 'Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ù†Ù‚Ù„', goods: 'Ù†Ù‚Ù„ Ø¨Ø¶Ø§Ø¦Ø¹',
                    repair: 'ØªØµÙ„ÙŠØ­ / ØµÙŠØ§Ù†Ø©', electrician: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', appliance: 'Ø¥ØµÙ„Ø§Ø­ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©',
                    store: 'Ù…Ø­Ù„ Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', restaurant: 'Ù…Ø·Ø§Ø¹Ù…',
                };
                
                this.init();
            }
            
            showLoading(msg = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
                document.getElementById('loadingMessage').innerText = msg;
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
            
            async init() {
                this.loadUserData();
                this.setupEventListeners();
                this.initMap();
                await this.loadChannelsAndBotToken();
                await this.loadOrdersFromSheet();
                this.state.isFirstLoad = false;
                this.startAutoUpdate();
                this.updateLocationStatus();
                this.updateAppStatus('Ø¬Ø§Ù‡Ø²');
                this.loadFilterPreference();
                this.showUnakenOrdersOnMap();
            }
            
            setupEventListeners() {
                document.getElementById('homeBtn').addEventListener('click', () => this.showSection('home'));
                document.getElementById('customerBtn').addEventListener('click', () => this.showSection('customer'));
                document.getElementById('providerBtn').addEventListener('click', () => this.showSection('provider'));
                document.getElementById('adminBtn').addEventListener('click', () => this.showSection('admin'));
                
                document.getElementById('customerForm').addEventListener('submit', (e) => this.saveCustomer(e));
                document.getElementById('providerForm').addEventListener('submit', (e) => this.saveProvider(e));
                document.getElementById('newOrderForm').addEventListener('submit', (e) => this.createOrder(e));
                document.getElementById('newOrderBtn').addEventListener('click', () => this.showNewOrderModal());
                document.getElementById('locateMeBtn').addEventListener('click', () => this.locateUser());
                document.getElementById('pickLocationBtn').addEventListener('click', () => this.showLocationPicker());
                document.getElementById('confirmLocationBtn').addEventListener('click', () => this.confirmLocation());
                document.getElementById('useCurrentLocationBtn').addEventListener('click', () => this.useCurrentLocationForPicker());
                document.getElementById('serviceFilter').addEventListener('change', (e) => {
                    this.filterOrders(e.target.value);
                    this.saveFilterPreference();
                });
                
                document.querySelectorAll('input[name="services"]').forEach(cb => {
                    cb.addEventListener('change', () => this.displayProviderChannels());
                });
                
                document.getElementById('adminLoginBtn').addEventListener('click', () => this.adminLogin());
                document.getElementById('saveChannelsBtn').addEventListener('click', () => this.saveChannels());
                
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => this.closeModals());
                });
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) this.closeModals();
                });
            }
            
            displayProviderChannels() {
                const selected = [];
                document.querySelectorAll('input[name="services"]:checked').forEach(cb => selected.push(cb.value));
                const container = document.getElementById('providerChannelsContainer');
                const tbody = document.getElementById('providerChannelsBody');
                if (selected.length === 0 || Object.keys(this.state.channels).length === 0) {
                    container.style.display = 'none';
                    return;
                }
                let html = '';
                selected.forEach(service => {
                    const ch = this.state.channels[service];
                    if (ch && ch.inviteLink) {
                        html += `<tr><td><i class="${this.serviceIcons[service]}"></i> ${this.serviceNames[service]}</td><td><a href="${ch.inviteLink}" target="_blank" class="channel-link"><i class="fab fa-telegram"></i> Ø±Ø§Ø¨Ø·</a></td><td><a href="${ch.inviteLink}" target="_blank" class="btn-success" style="padding:0.4rem 1rem;">Ø§Ù†Ø¶Ù…Ø§Ù…</a></td></tr>`;
                    }
                });
                if (html) { tbody.innerHTML = html; container.style.display = 'block'; }
                else container.style.display = 'none';
            }
            
            displayAdminChannels() {
                const tbody = document.getElementById('adminChannelsBody');
                let html = '';
                Object.keys(this.serviceNames).forEach(service => {
                    const ch = this.state.channels[service] || { username: '', inviteLink: '' };
                    html += `<tr><td><i class="${this.serviceIcons[service]}"></i> ${this.serviceNames[service]}</td><td><input type="text" id="username_${service}" value="${ch.username || ''}" placeholder="@username" style="width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #ddd;"></td><td><input type="text" id="link_${service}" value="${ch.inviteLink || ''}" placeholder="https://t.me/..." style="width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #ddd;"></td></tr>`;
                });
                tbody.innerHTML = html;
                document.getElementById('adminBotToken').value = this.state.botToken || '';
            }
            
            adminLogin() {
                if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                    this.state.adminLoggedIn = true;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    this.loadChannelsAndBotToken().then(() => this.displayAdminChannels());
                    this.showAlert('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success');
                } else this.showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©', 'error');
            }
            
            async saveChannels() {
                const channels = {};
                Object.keys(this.serviceNames).forEach(service => {
                    channels[service] = {
                        username: document.getElementById(`username_${service}`).value.trim(),
                        inviteLink: document.getElementById(`link_${service}`).value.trim()
                    };
                });
                const botToken = document.getElementById('adminBotToken').value.trim();
                this.showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
                try {
                    await this.callAppsScript('saveChannels', { channels: JSON.stringify(channels), botToken });
                    this.state.channels = channels;
                    this.state.botToken = botToken;
                    this.hideLoading();
                    this.showAlert('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
                    this.displayProviderChannels();
                } catch (error) {
                    this.hideLoading();
                    this.showAlert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error');
                }
            }
            
            async callAppsScript(action, data = {}) {
                const formData = new URLSearchParams({ action, ...data });
                const res = await fetch(this.config.API_BASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData });
                if (!res.ok) throw new Error('Network error');
                const result = await res.json();
                if (result.error) throw new Error(result.error);
                return result;
            }
            
            async loadChannelsAndBotToken() {
                try {
                    const res = await this.callAppsScript('getChannels');
                    this.state.channels = res.channels || {};
                    this.state.botToken = res.botToken || '';
                } catch { this.state.channels = {}; this.state.botToken = ''; }
            }
            
            async loadOrdersFromSheet() {
                try {
                    const res = await this.callAppsScript('getOrders');
                    this.state.orders = (res.orders || []).map(o => ({ ...o, hidden: o.hidden === true || o.hidden === 'true' }));
                    this.cleanOldOrders();
                    this.state.takenOrders = this.state.orders.filter(o => o.status === 'taken' && o.takenBy === this.state.provider?.id);
                    this.saveToStorage('orders', this.state.orders);
                    this.saveToStorage('takenOrders', this.state.takenOrders);
                    this.updateDisplay();
                } catch {
                    this.state.orders = this.getFromStorage('orders') || [];
                    this.state.takenOrders = this.getFromStorage('takenOrders') || [];
                } finally { this.hideLoading(); }
            }
            
            async saveOrdersToSheet() {
                try { await this.callAppsScript('saveOrders', { orders: JSON.stringify(this.state.orders) }); } catch {}
                this.saveToStorage('orders', this.state.orders);
                this.saveToStorage('takenOrders', this.state.takenOrders);
            }
            
            async sendBotNotifications(order) {
                if (this.state.isFirstLoad || !this.state.botToken) return;
                const ch = this.state.channels[order.service];
                if (!ch || !ch.username) return;
                await this.sendTelegramMessage(this.state.botToken, ch.username, order);
            }
            
            async sendTelegramMessage(token, chatId, order) {
                if (!chatId) return false;
                const distance = this.calculateDistance(this.config.MAP_CENTER[0], this.config.MAP_CENTER[1], order.location.lat, order.location.lng).toFixed(1);
                const msg = = `
â™» *Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”§ *Ø§Ù„Ø®Ø¯Ù…Ø©:* ${this.serviceNames[order.service]}
ğŸ“*Ø§Ù„ØªÙØ§ØµÙŠÙ„:* ${order.details}
---------------------------------------------------
ğŸ“ *Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${order.location.address}
ğŸ“ *Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…Ø±ÙƒØ² Ø¥Ø¯Ù„Ø¨:* ${distance} ÙƒÙ…
ğŸ“ *Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:* ${order.phone}
ğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${order.customerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ—ºï¸ *Ø§Ù„Ø®Ø±ÙŠØ·Ø©:* https://maps.google.com/?q=${order.location.lat},${order.location.lng}
ğŸ“± *Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:* https://wa.me/${order.phone}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”

                    `;
                try {
                    const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: chatId, text: msg, parse_mode: 'Markdown' })
                    });
                    return (await res.json()).ok;
                } catch { return false; }
            }
            
            initMap() {
                this.state.map = L.map('map').setView(this.config.MAP_CENTER, this.config.MAP_ZOOM);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(this.state.map);
                this.getUserLocation();
            }
            
            initLocationPickerMap() {
                if (!this.state.locationPickerMap) {
                    this.state.locationPickerMap = L.map('locationMap').setView(this.config.MAP_CENTER, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.state.locationPickerMap);
                    this.state.locationMarker = L.marker(this.config.MAP_CENTER, { draggable: true }).addTo(this.state.locationPickerMap);
                    this.state.locationMarker.on('dragend', (e) => {
                        const p = e.target.getLatLng();
                        this.state.selectedOrderLocation = { lat: p.lat, lng: p.lng, address: `Ù…ÙˆÙ‚Ø¹: ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}` };
                    });
                    this.state.locationPickerMap.on('click', (e) => {
                        this.state.locationMarker.setLatLng(e.latlng);
                        this.state.selectedOrderLocation = { lat: e.latlng.lat, lng: e.latlng.lng, address: `Ù…ÙˆÙ‚Ø¹: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}` };
                    });
                }
                const initLoc = this.state.currentPosition || { lat: this.config.MAP_CENTER[0], lng: this.config.MAP_CENTER[1] };
                this.state.locationPickerMap.setView([initLoc.lat, initLoc.lng], 13);
                this.state.locationMarker.setLatLng([initLoc.lat, initLoc.lng]);
                this.state.selectedOrderLocation = { ...initLoc, address: `Ù…ÙˆÙ‚Ø¹: ${initLoc.lat.toFixed(6)}, ${initLoc.lng.toFixed(6)}` };
            }
            
            getUserLocation() {
                return new Promise(resolve => {
                    if (!navigator.geolocation) { this.updateLocationStatus('ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'); resolve(false); return; }
                    navigator.geolocation.getCurrentPosition(
                        pos => {
                            this.state.currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude, address: 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ' };
                            this.updateLocationStatus('Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø¬Ø§Ù‡Ø²');
                            resolve(true);
                        },
                        err => {
                            let msg = 'ØªØ¹Ø°Ø±';
                            if (err.code === err.PERMISSION_DENIED) msg = 'ØªÙ… Ø§Ù„Ø±ÙØ¶';
                            else if (err.code === err.POSITION_UNAVAILABLE) msg = 'ØºÙŠØ± Ù…ØªØ§Ø­';
                            else if (err.code === err.TIMEOUT) msg = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©';
                            this.updateLocationStatus(msg);
                            resolve(false);
                        }, { enableHighAccuracy: true, timeout: 10000 }
                    );
                });
            }
            
            updateLocationStatus(status) {
                const el = document.getElementById('locationStatus')?.querySelector('span');
                if (el) el.textContent = status;
            }
            
            locateUser() {
                this.getUserLocation().then(ok => {
                    if (ok && this.state.map) {
                        this.state.map.setView([this.state.currentPosition.lat, this.state.currentPosition.lng], 13);
                        this.showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ', 'success');
                        this.updateDisplay();
                    } else { this.showAlert('ØªØ¹Ø°Ø±ØŒ Ø­Ø§ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹', 'warning'); this.showLocationPicker(); }
                });
            }
            
            showLocationPicker() {
                this.initLocationPickerMap();
                this.showModal('locationPickerModal');
            }
            
            confirmLocation() {
                if (!this.state.selectedOrderLocation) { this.showAlert('Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ø§Ù‹', 'error'); return; }
                document.getElementById('locationPickerModal').classList.remove('active');
                const locInfo = document.getElementById('orderLocationInfo');
                if (locInfo) {
                    locInfo.innerHTML = `<p><strong style="color:#28a745;">âœ“ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯:</strong> ${this.state.selectedOrderLocation.address}</p><button type="button" id="pickLocationBtn" class="btn-secondary"><i class="fas fa-map-pin"></i> ØªØºÙŠÙŠØ±</button>`;
                    document.getElementById('pickLocationBtn').addEventListener('click', () => this.showLocationPicker());
                }
                this.showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'success');
            }
            
            useCurrentLocationForPicker() {
                if (this.state.currentPosition) {
                    this.state.locationPickerMap.setView([this.state.currentPosition.lat, this.state.currentPosition.lng], 13);
                    this.state.locationMarker.setLatLng([this.state.currentPosition.lat, this.state.currentPosition.lng]);
                    this.state.selectedOrderLocation = this.state.currentPosition;
                    this.showAlert('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ', 'success');
                } else {
                    this.getUserLocation().then(ok => {
                        if (ok) {
                            this.state.locationPickerMap.setView([this.state.currentPosition.lat, this.state.currentPosition.lng], 13);
                            this.state.locationMarker.setLatLng([this.state.currentPosition.lat, this.state.currentPosition.lng]);
                            this.state.selectedOrderLocation = this.state.currentPosition;
                            this.showAlert('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ', 'success');
                        }
                    });
                }
            }
            
            showNewOrderModal() {
                if (!this.state.user) { this.showAlert('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹', 'error'); this.showSection('customer'); return; }
                this.state.selectedOrderLocation = null;
                const locInfo = document.getElementById('orderLocationInfo');
                if (locInfo) {
                    if (this.state.currentPosition) {
                        locInfo.innerHTML = `<p>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ <span style="color:#6c757d;">(${this.state.currentPosition.address})</span></p><button type="button" id="pickLocationBtn" class="btn-secondary"><i class="fas fa-map-pin"></i> ØªØºÙŠÙŠØ±</button>`;
                        document.getElementById('pickLocationBtn').addEventListener('click', () => this.showLocationPicker());
                    } else {
                        locInfo.innerHTML = `<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p><button type="button" id="pickLocationBtn" class="btn-secondary"><i class="fas fa-map-pin"></i> ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹</button>`;
                        this.getUserLocation().then(ok => {
                            if (ok) {
                                locInfo.innerHTML = `<p>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ <span style="color:#6c757d;">(${this.state.currentPosition.address})</span></p><button type="button" id="pickLocationBtn" class="btn-secondary"><i class="fas fa-map-pin"></i> ØªØºÙŠÙŠØ±</button>`;
                                document.getElementById('pickLocationBtn').addEventListener('click', () => this.showLocationPicker());
                            }
                        });
                        document.getElementById('pickLocationBtn').addEventListener('click', () => this.showLocationPicker());
                    }
                }
                this.showModal('newOrderModal');
            }
            
            async createOrder(e) {
                e.preventDefault();
                if (!this.state.user) return;
                if (!this.state.user.phone.startsWith('+963') || this.state.user.phone.length < 13) {
                    this.showAlert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); this.showSection('customer'); return;
                }
                const service = document.getElementById('orderService').value;
                const details = document.getElementById('orderDetails').value;
                if (!service || !details) { this.showAlert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error'); return; }
                
                let location = this.state.selectedOrderLocation || this.state.currentPosition;
                if (!location) {
                    const { value: accept } = await Swal.fire({ title: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', text: 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ØŒ Ø­Ø¯Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ', icon: 'info', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡' });
                    if (accept) { this.showLocationPicker(); return; } else return;
                }
                
                this.closeModals();
                this.showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                
                const order = {
                    id: 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    service, details, location,
                    phone: this.state.user.phone,
                    customerName: this.state.user.name,
                    userId: this.state.user.id,
                    timestamp: new Date().toISOString(),
                    status: 'new',
                    hidden: false
                };
                
                try {
                    this.state.orders.push(order);
                    this.state.newOrdersCheck.push(order.id);
                    this.saveToStorage('newOrdersCheck', this.state.newOrdersCheck);
                    this.addOrderToMap(order);
                    await this.saveOrdersToSheet();
                    await this.sendBotNotifications(order);
                    this.hideLoading();
                    this.showAlert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'success');
                    document.getElementById('newOrderForm').reset();
                    this.state.selectedOrderLocation = null;
                    this.updateDisplay();
                } catch (error) {
                    this.hideLoading();
                    Swal.fire({ title: 'ÙØ´Ù„', text: 'Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©ØŸ', icon: 'error', showCancelButton: true }).then(r => {
                        if (r.isConfirmed) { this.showNewOrderModal(); document.getElementById('orderService').value = service; document.getElementById('orderDetails').value = details; this.state.selectedOrderLocation = location; }
                    });
                }
            }
            
            addOrderToMap(order) {
                const marker = L.marker([order.location.lat, order.location.lng], {
                    icon: L.divIcon({
                        className: 'order-marker',
                        html: `<div style="background:${this.getStatusColor(order.status)}; width:2.5rem; height:2.5rem; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; border:2px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3);"><i class="${this.serviceIcons[order.service]}" style="font-size:1.2rem;"></i></div>`,
                        iconSize: [40,40], iconAnchor: [20,20]
                    })
                }).addTo(this.state.map);
                marker.bindPopup(this.createPopup(order));
                marker.on('click', () => this.viewOrder(order.id));
                this.state.markers[order.id] = marker;
            }
            
            cleanOldOrders() {
                const now = Date.now();
                this.state.orders = this.state.orders.filter(o => {
                    const t = new Date(o.timestamp).getTime();
                    const age = now - t;
                    if ((o.status === 'completed' || o.status === 'cancelled') && age > 2 * 60 * 1000) return false;
                    if (o.status === 'new' && age > this.config.ORDER_TIMEOUT) return false; // 10 Ø¯Ù‚Ø§Ø¦Ù‚
                    if (o.status === 'taken') {
                        const takenAge = now - (o.takenAt || t);
                        o.hidden = takenAge > this.config.TAKEN_TIMEOUT;
                    }
                    return true;
                });
            }
            
            updateMap() {
                Object.values(this.state.markers).forEach(m => m?.remove());
                this.state.markers = {};
                const filter = document.getElementById('serviceFilter').value;
                this.state.orders.forEach(o => {
                    if (!o.location || o.status === 'completed' || o.status === 'cancelled' || o.hidden) return;
                    if (filter === 'all' || o.service === filter) this.addOrderToMap(o);
                });
            }
            
            getStatusColor(s) { return { new: '#4361ee', taken: '#f8961e', completed: '#4cc9f0', cancelled: '#f94144' }[s] || '#4361ee'; }
            
            createPopup(o) {
                const dist = this.state.currentPosition ? this.calculateDistance(this.state.currentPosition.lat, this.state.currentPosition.lng, o.location.lat, o.location.lng).toFixed(1) : '?';
                return `<div style="padding:0.5rem; max-width:250px;"><h4 style="margin:0 0 0.5rem; color:#6a11cb;"><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</h4><p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${this.getStatusText(o.status)}</p><p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${dist} ÙƒÙ…</p><p><strong>Ø±Ù‚Ù…:</strong> ${o.phone}</p><p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${o.details.substring(0,50)}...</p><button onclick="app.viewOrder('${o.id}')" style="background:#6a11cb; color:white; border:none; padding:0.5rem; border-radius:2rem; width:100%;">Ø¹Ø±Ø¶</button></div>`;
            }
            
            updateNearbyOrders() {
                const cont = document.getElementById('nearbyOrders');
                if (!cont || !this.state.currentPosition) { cont.innerHTML = '<p style="text-align:center;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­</p>'; return; }
                const filter = document.getElementById('serviceFilter').value;
                let list = this.state.orders.filter(o => o.status === 'new' && !o.hidden && (filter === 'all' || o.service === filter) && o.location);
                list.forEach(o => o.distance = this.calculateDistance(this.state.currentPosition.lat, this.state.currentPosition.lng, o.location.lat, o.location.lng));
                list = list.filter(o => o.distance <= this.config.NEARBY_DISTANCE).sort((a,b) => a.distance - b.distance);
                if (!list.length) { cont.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ø¶Ù…Ù† 2 ÙƒÙ…</p>'; return; }
                cont.innerHTML = list.map(o => `<div class="order-item"><div class="order-item-header"><span class="order-item-service"><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</span><span class="order-item-status status-new">Ø¬Ø¯ÙŠØ¯</span></div><div class="order-item-details">${o.details.substring(0,80)}...</div><div class="order-item-footer"><span><i class="fas fa-map-marker-alt"></i> ${o.distance.toFixed(1)} ÙƒÙ…</span><div class="order-item-actions"><button class="btn-secondary" onclick="app.viewOrder('${o.id}')"><i class="fas fa-eye"></i></button>${this.state.provider ? `<button class="btn-success" onclick="app.takeOrder('${o.id}')"><i class="fas fa-hand-paper"></i></button>` : ''}</div></div></div>`).join('');
            }
            
            updateSuggestedOrders() {
                const cont = document.getElementById('suggestedOrders');
                if (!cont || !this.state.currentPosition) { cont.innerHTML = ''; return; }
                const filter = document.getElementById('serviceFilter').value;
                let list = this.state.orders.filter(o => o.status === 'new' && !o.hidden && (filter !== 'all' ? o.service !== filter : true) && o.location);
                list.forEach(o => o.distance = this.calculateDistance(this.state.currentPosition.lat, this.state.currentPosition.lng, o.location.lat, o.location.lng));
                list = list.filter(o => o.distance <= this.config.NEARBY_DISTANCE).sort((a,b) => a.distance - b.distance).slice(0,4);
                if (!list.length) { cont.innerHTML = '<p style="text-align:center; color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</p>'; return; }
                cont.innerHTML = list.map(o => `<div class="order-item" style="border-right-color:#f39c12;"><div class="order-item-header"><span class="order-item-service"><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</span><span class="order-item-status status-new">Ø¬Ø¯ÙŠØ¯</span></div><div class="order-item-details">${o.details.substring(0,60)}...</div><div class="order-item-footer"><span><i class="fas fa-map-marker-alt"></i> ${o.distance.toFixed(1)} ÙƒÙ…</span><button class="btn-secondary" onclick="app.viewOrder('${o.id}')"><i class="fas fa-eye"></i></button></div></div>`).join('');
            }
            
            async takeOrder(id) {
                if (!this.state.provider) { this.showAlert('Ø£ÙƒÙ…Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©', 'error'); this.showSection('provider'); return; }
                const o = this.state.orders.find(x => x.id === id);
                if (!o || o.status !== 'new') { this.showAlert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­', 'warning'); return; }
                o.status = 'taken'; o.takenBy = this.state.provider.id; o.takenAt = Date.now(); o.takenByName = this.state.provider.name; o.hidden = false;
                this.state.takenOrders.push(o);
                await this.saveOrdersToSheet();
                this.updateDisplay();
                this.showAlert('ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø·Ù„Ø¨', 'success');
                if (o.phone) window.open(`https://wa.me/${o.phone}?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ ${o.customerName}ØŒ ${o.takenByName} Ù‚Ø§Ù… Ø¨Ø£Ø®Ø° Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.`, '_blank');
            }
            
            async cancelOrder(id) {
                const o = this.state.orders.find(x => x.id === id);
                if (!o) return;
                if (o.status === 'taken' && o.takenBy === this.state.provider?.id) {
                    o.status = 'new'; o.takenBy = null; o.takenAt = null; o.takenByName = null; o.hidden = false;
                    this.state.takenOrders = this.state.takenOrders.filter(x => x.id !== id);
                } else if (o.userId === this.state.user?.id) o.status = 'cancelled';
                await this.saveOrdersToSheet();
                this.updateDisplay();
                this.showAlert('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
            }
            
            async completeOrder(id) {
                const o = this.state.orders.find(x => x.id === id);
                if (!o) return;
                o.status = 'completed'; o.completedAt = Date.now();
                this.state.takenOrders = this.state.takenOrders.filter(x => x.id !== id);
                await this.saveOrdersToSheet();
                this.updateDisplay();
                this.showAlert('ØªÙ… Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„', 'success');
            }
            
            filterOrders(s) { this.updateMap(); this.updateNearbyOrders(); this.updateSuggestedOrders(); }
            saveFilterPreference() { this.saveToStorage('filter', document.getElementById('serviceFilter').value); }
            loadFilterPreference() { document.getElementById('serviceFilter').value = this.getFromStorage('filter') || 'all'; }
            updateDisplay() { this.updateMap(); this.updateNearbyOrders(); this.updateSuggestedOrders(); this.renderMyOrders(); this.renderTakenOrders(); }
            
            showUnakenOrdersOnMap() {
                const u = this.state.orders.filter(o => o.status === 'new' && o.location);
                if (u.length) {
                    const lat = u.reduce((s,o)=>s+o.location.lat,0)/u.length;
                    const lng = u.reduce((s,o)=>s+o.location.lng,0)/u.length;
                    this.state.map.setView([lat,lng], 11);
                    this.showAlert(`ÙŠÙˆØ¬Ø¯ ${u.length} Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø£Ø®ÙˆØ°`, 'info');
                }
            }
            
            startAutoUpdate() {
                if (this.state.updateTimer) clearInterval(this.state.updateTimer);
                this.state.updateTimer = setInterval(async () => {
                    const old = [...this.state.orders];
                    await this.loadOrdersFromSheet();
                    if (!this.state.isFirstLoad && old.length) this.checkForNewOrdersOnly(old);
                    this.updateAppStatus('Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date().toLocaleTimeString('ar-SA'));
                }, this.config.UPDATE_INTERVAL);
            }
            
            checkForNewOrdersOnly(old) {
                if (!this.state.provider) return;
                const oldIds = new Set(old.map(o=>o.id));
                const oldNewIds = new Set(old.filter(o=>o.status==='new').map(o=>o.id));
                const newOrders = this.state.orders.filter(o=>o.status==='new' && !oldIds.has(o.id));
                const react = this.state.orders.filter(o=>o.status==='new' && oldIds.has(o.id) && !oldNewIds.has(o.id) && !this.state.newOrdersCheck.includes(o.id));
                [...newOrders, ...react].forEach(o => { this.sendBotNotifications(o); if (!this.state.newOrdersCheck.includes(o.id)) this.state.newOrdersCheck.push(o.id); });
                if (newOrders.length || react.length) { this.showAlert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newOrders.length+react.length} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯`, 'success'); this.saveToStorage('newOrdersCheck', this.state.newOrdersCheck); }
            }
            
            showSection(s) {
                document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(s + 'Section').classList.add('active');
                document.getElementById(s + 'Btn').classList.add('active');
                if (s === 'home') { setTimeout(() => this.state.map?.invalidateSize(), 100); this.updateDisplay(); }
                else if (s === 'customer') this.renderMyOrders();
                else if (s === 'provider') { this.renderTakenOrders(); this.displayProviderChannels(); }
                else if (s === 'admin') {
                    if (this.state.adminLoggedIn) { document.getElementById('adminLogin').style.display = 'none'; document.getElementById('adminContent').style.display = 'block'; this.displayAdminChannels(); }
                    else { document.getElementById('adminLogin').style.display = 'block'; document.getElementById('adminContent').style.display = 'none'; document.getElementById('adminPassword').value = ''; }
                }
            }
            
            showModal(id) { document.getElementById(id).classList.add('active'); }
            closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
            showAlert(msg, type='info') { Swal.fire({ title: msg, icon: type, timer: 2000, toast: true, position: 'top-end', showConfirmButton: false }); }
            
            viewOrder(id) {
                const o = this.state.orders.find(x => x.id === id);
                if (!o) return;
                const content = document.getElementById('orderDetailsContent');
                content.innerHTML = `<div><h4 style="color:#6a11cb;"><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</h4><p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${o.details}</p><p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${o.location.address}</p><p><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${o.customerName} - <a href="https://wa.me/${o.phone}" target="_blank">${o.phone}</a></p><p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${this.getStatusText(o.status)}</p><div style="display:flex; gap:0.8rem; margin-top:1.5rem;">${o.status==='new' && this.state.provider ? `<button onclick="app.takeOrder('${o.id}')" class="btn-primary">Ø£Ø®Ø° Ø§Ù„Ø·Ù„Ø¨</button>` : ''}${o.status==='taken' && o.takenBy === this.state.provider?.id ? `<button onclick="app.completeOrder('${o.id}')" class="btn-success">Ø¥ÙƒÙ…Ø§Ù„</button><button onclick="app.cancelOrder('${o.id}')" class="btn-danger">Ø¥Ù„ØºØ§Ø¡</button>` : ''}${o.userId === this.state.user?.id && o.status === 'new' ? `<button onclick="app.cancelOrder('${o.id}')" class="btn-danger">Ø¥Ù„ØºØ§Ø¡</button>` : ''}</div></div>`;
                this.showModal('orderDetailsModal');
            }
            
            async saveCustomer(e) {
                e.preventDefault();
                const name = document.getElementById('customerName').value;
                const phone = document.getElementById('customerPhone').value;
                if (!name || !phone) { this.showAlert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error'); return; }
                if (!phone.startsWith('+963') || phone.length < 13) { this.showAlert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); return; }
                this.state.user = { id: 'user_'+Date.now(), name, phone, createdAt: new Date().toISOString() };
                this.saveToStorage('user', this.state.user);
                this.showAlert('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
                this.renderMyOrders();
            }
            
            async saveProvider(e) {
                e.preventDefault();
                const name = document.getElementById('providerName').value;
                const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(cb=>cb.value);
                if (!name || !services.length) { this.showAlert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error'); return; }
                this.state.provider = { id: 'provider_'+Date.now(), name, services, createdAt: new Date().toISOString() };
                this.saveToStorage('provider', this.state.provider);
                this.resetNewOrdersCheck();
                this.showAlert('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
                this.renderTakenOrders();
                this.displayProviderChannels();
            }
            
            renderMyOrders() {
                const cont = document.getElementById('myOrdersList');
                if (!cont) return;
                const list = this.state.orders.filter(o => o.userId === this.state.user?.id).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
                if (!list.length) { cont.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'; return; }
                cont.innerHTML = list.map(o => `<div style="background:#f8f9fa; padding:1rem; border-radius:1rem; margin-bottom:1rem; border-right:0.3rem solid ${this.getStatusColor(o.status)};"><div style="display:flex; justify-content:space-between; align-items:center;"><strong><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</strong><span style="background:${this.getStatusColor(o.status)}20; color:${this.getStatusColor(o.status)}; padding:0.2rem 1rem; border-radius:2rem; font-size:0.85rem;">${this.getStatusText(o.status)}</span></div><p style="margin:0.5rem 0;">${o.details.substring(0,80)}...</p><small>${new Date(o.timestamp).toLocaleString('ar-SA')}</small></div>`).join('');
            }
            
            renderTakenOrders() {
                const cont = document.getElementById('takenOrdersList');
                if (!cont) return;
                if (!this.state.takenOrders.length) { cont.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø£Ø®ÙˆØ°Ø©</p>'; return; }
                cont.innerHTML = this.state.takenOrders.map(o => `<div style="background:#fff3e0; padding:1rem; border-radius:1rem; margin-bottom:1rem; border-right:0.3rem solid #f8961e;"><strong><i class="${this.serviceIcons[o.service]}"></i> ${this.serviceNames[o.service]}</strong><p style="margin:0.5rem 0;">${o.details.substring(0,80)}...</p><p>Ø§Ù„Ø²Ø¨ÙˆÙ†: <a href="https://wa.me/${o.phone}" target="_blank">${o.phone}</a></p><div style="display:flex; gap:0.8rem;"><button onclick="app.completeOrder('${o.id}')" class="btn-success">Ø¥ÙƒÙ…Ø§Ù„</button><button onclick="app.cancelOrder('${o.id}')" class="btn-danger">Ø¥Ù„ØºØ§Ø¡</button></div></div>`).join('');
            }
            
            resetNewOrdersCheck() { this.state.newOrdersCheck = this.state.orders.filter(o=>o.status==='new').map(o=>o.id); this.saveToStorage('newOrdersCheck', this.state.newOrdersCheck); }
            calculateDistance(lat1,lon1,lat2,lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
            getStatusText(s) { return { new:'Ø¬Ø¯ÙŠØ¯', taken:'Ù…Ø£Ø®ÙˆØ°', completed:'Ù…ÙƒØªÙ…Ù„', cancelled:'Ù…Ù„ØºÙ‰' }[s] || s; }
            
            loadUserData() {
                this.state.user = this.getFromStorage('user');
                this.state.provider = this.getFromStorage('provider');
                this.state.orders = this.getFromStorage('orders') || [];
                this.state.takenOrders = this.getFromStorage('takenOrders') || [];
                this.state.newOrdersCheck = this.getFromStorage('newOrdersCheck') || [];
                if (this.state.user) { document.getElementById('customerName').value = this.state.user.name || ''; document.getElementById('customerPhone').value = this.state.user.phone || ''; }
                if (this.state.provider) {
                    document.getElementById('providerName').value = this.state.provider.name || '';
                    document.querySelectorAll('input[name="services"]').forEach(cb => cb.checked = this.state.provider.services?.includes(cb.value) || false);
                }
            }
            getFromStorage(k) { try { return JSON.parse(localStorage.getItem(`talabat_${k}`)); } catch { return null; } }
            saveToStorage(k, d) { localStorage.setItem(`talabat_${k}`, JSON.stringify(d)); }
            updateAppStatus(s) { document.getElementById('appStatus').textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + s; }
        }
        
        let app;
        window.addEventListener('DOMContentLoaded', () => { app = new TalabatApp(); window.app = app; });
    </script>
    
    <script src=".js" type="text/javascript" charset="utf-8"></script>
</body>
</html>